<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Tekton Coverage Dashboard</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.9.0/d3.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      background: #f5f5f5;
      padding: 2em;
      color: #333;
    }

    h1 {
      color: #007acc;
      margin-bottom: 0.5em;
    }

    a {
      color: #007acc;
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
    }

    th, td {
      padding: 0.75em;
      text-align: left;
      border-bottom: 1px solid #eee;
    }

    th {
      background: #007acc;
      color: white;
    }

    .bar-container {
      background: #eee;
      height: 16px;
      width: 100%;
      max-width: 200px;
      border-radius: 8px;
      overflow: hidden;
    }

    .bar {
      height: 100%;
      text-align: right;
      padding-right: 5px;
      color: white;
      font-size: 12px;
      line-height: 16px;
    }

    .green { background: #4caf50; }
    .orange { background: #ff9800; }
    .red { background: #f44336; }

    .status-ok { color: green; font-weight: bold; }
    .status-failed { color: red; font-weight: bold; }

    #run-link {
      margin-bottom: 1em;
    }
  </style>
</head>
<body>
  <h1>Tekton Coverage Dashboard</h1>
  <div id="run-link"></div>
  <table id="dashboard">
    <thead>
      <tr>
        <th>Repository</th>
        <th>Coverage</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    d3.json("coverage.json").then(json => {
      const runUrl = json.run_url;
      const data = json.data;

      // Show GitHub Actions run link
      if (runUrl) {
        d3.select("#run-link").append("a")
          .attr("href", runUrl)
          .attr("target", "_blank")
          .text("üîó Last updated via GitHub Actions run");
      }

      // Sort: OK first, then by coverage descending
      data.sort((a, b) => {
        if (a.status !== b.status) return a.status === 'ok' ? -1 : 1;
        return (b.coverage || 0) - (a.coverage || 0);
      });

      const rows = d3.select("tbody")
        .selectAll("tr")
        .data(data)
        .enter()
        .append("tr");

      // Repository column
      rows.append("td")
        .append("a")
        .attr("href", d => `https://github.com/${d.repo}`)
        .attr("target", "_blank")
        .text(d => d.repo);

      // Coverage column with bar
      rows.append("td").html(d => {
        if (isNaN(d.coverage)) return "N/A";

        const cov = parseFloat(d.coverage).toFixed(1);
        let color = "red";
        if (cov >= 80) color = "green";
        else if (cov >= 50) color = "orange";

        return `
          <div class="bar-container">
            <div class="bar ${color}" style="width:${cov}%">${cov}%</div>
          </div>`;
      });

      // Status column
      rows.append("td")
        .attr("class", d => `status-${d.status}`)
        .text(d => d.status === 'ok' ? '‚úÖ OK' : '‚ùå Failed');
    }).catch(error => {
      d3.select("tbody")
        .append("tr")
        .append("td")
        .attr("colspan", 3)
        .text("‚ö†Ô∏è Failed to load coverage data.");
      console.error("Failed to load coverage.json", error);
    });
  </script>
</body>
</html>

